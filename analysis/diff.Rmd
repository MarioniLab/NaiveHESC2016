---
title: "Single-cell RNA-seq of naive/primed embryonic stem cells: differential variability" 
author: Tobias Messmer and Aaron Lun
date: 13 November 2017
output: 
  html_document:
    toc: true
    toc_float: true
    depth: 3
    number_sections: true
    theme: united 
    highlight: tango 
    fig_caption: false
---

```{r, echo=FALSE, results="hide"}
dir.create("figure-diff/", showWarning=FALSE)
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE, fig.path="figure-diff/")
options(bitmapType="cairo", width=100)
library(BiocParallel)
register(SerialParam())
set.seed(100)
```

# Data preparation

The idea here is to test for whether there are any changes in gene expression of germlayer specific markers within the naive and the primed population, respectively.
This will allow us to determine whether the primed cells prepare for differentiation into the three germ layers.
First, we load the counts of our cells and the germ layer markers.
We identify the transition cells in the naive population to prune them out.
This ensures that we're identifying effects of homogeneous populations.

```{r load.objects}
library(scran)
sce <- readRDS("sce_all.rds")
true.groups <- read.table(file.path("results-transition", "groups.tsv"), header=TRUE, stringsAsFactors=FALSE)
sce <- sce[,true.groups$Type[match(colnames(sce), true.groups$Cell)]!="transition"]
sce_naive <- sce[,sce$phenotype == "naive"]
sce_primed <- sce[,sce$phenotype == "primed"]
```

We also set up an output directory.

```{r def.dir}
resdir <- "results-diff"
dir.create(resdir, showWarning=FALSE)
```

```{r get.list}
by.lineage <- read.csv(file.path("../data/marker", "commit_lineages.csv"), header=TRUE, stringsAsFactors=FALSE, sep= ';')
lin.markers <- by.lineage$Symbol
```

Setting up a function to identify the surviving genes.

```{r adj.list}
library(org.Hs.eg.db)
inPresentSet <- function(present, desired) {
    ensembls <- mapIds(org.Hs.eg.db, keytype="SYMBOL", keys=desired, column="ENSEMBL")
    which(present %in% ensembls)    
}
lin.markers <- inPresentSet(rowData(sce)$ensembl_gene_id, lin.markers)
lin.markers <- rownames(sce)[lin.markers]

#Export the table of the used markers
whole.list <- by.lineage[which(by.lineage$Symbol %in% lin.markers),]
whole.list <- whole.list[(!duplicated(whole.list$Symbol)),]
write.table(file=file.path(resdir, "linmarkers.tsv"), whole.list, sep="\t", quote=FALSE, row.names= F) 
```

Because we removed the transition cells from the naive subpopulation, we have to calculate the PCs freshly.
It is important not to forget to remove the batch effect to ensure that they don't distord the clustering. 

```{r naive.vartrend}
library(limma)
library(scater)

sce_naive <- multiBlockNorm(sce_naive, sce_naive$batch)
var.out_naive <- multiBlockVar(sce_naive, block=sce_naive$batch,
    trend.args=list(parametric=TRUE, loess.args=list(span=0.4)))

norm_exprs(sce_naive) <- removeBatchEffect(exprs(sce_naive), batch=sce_naive$batch) 
chosen.npcs_naive <- denoisePCA(sce_naive, var.out_naive, value="n", assay.type="norm_exprs")

#keep <- var.out_naive$bio > 0
#pc.out <- prcomp(t(assay(sce_naive, "norm_exprs")[keep,,drop=FALSE]), rank=chosen.npcs_naive)
#reducedDim(sce_naive, "PCA") <- pc.out$x
```

Now we repeat the same for the primed population.

```{r primed.vartrend, fig.height=6, fig.width=10}
par(mfrow=c(1,2))
sce_primed <- multiBlockNorm(sce_primed, sce_primed$batch)
var.out_primed <- multiBlockVar(sce_primed, block=sce_primed$batch,
    trend.args=list(parametric=TRUE, loess.args=list(span=0.4)))

norm_exprs(sce_primed) <- removeBatchEffect(exprs(sce_primed), batch=sce_primed$batch) 
chosen.npcs_primed <- denoisePCA(sce_primed, var.out_primed, value="n", assay.type="norm_exprs")

#keep <- var.out_primed$bio > 0
#pc.out <- prcomp(t(assay(sce_primed, "norm_exprs")[keep,,drop=FALSE]), rank=chosen.npcs_primed)
#reducedDim(sce_primed, "PCA") <- pc.out$x
```

We can now have a first glimpse on the the naive and primed populations to check whether they form any clusters and color the PCA/tSNE according to their expression of cell-cycle related genes. If cell-cycle related genes colour different parts of the PCA/tSNE, this is an indication that cell-cycle is the great driver for heterogeneity in the populations.

```{r plot.all}
library(ggplot2)
fontsize <- theme(axis.text=element_text(size=12), axis.title=element_text(size=16), title = element_text(size=12))

pca_naive <- plotPCA(sce_naive, colour_by = "CDK1") + fontsize
tsne_naive <- plotTSNE(sce_naive, colour_by= "CDK1") + fontsize

sce_naive <- runTSNE(sce_naive, perplexity=30, exprs_values="norm_exprs")
sce_primed <- runTSNE(sce_primed, perplexity=30, exprs_values="norm_exprs")
#sce_naive <- runPCA(sce_naive, use_dimred="PCA", exprs_values="norm_exprs")
#sce_primed <- runPCA(sce_primed, use_dimred="PCA", exprs_values="norm_exprs")

pca_primed <- plotPCA(sce_primed, colour_by = "CDK1") + fontsize
tsne_primed <- plotTSNE(sce_primed, colour_by= "CDK1") + fontsize

multiplot(pca_naive, tsne_naive, pca_primed, tsne_primed, cols=2)

saveRDS(pca_naive, file = file.path(resdir, 'naive_plot.Rds'))
saveRDS(pca_primed, file = file.path(resdir, 'primed_plot.Rds'))
```

# Naive population clustering

We now want to further assess whether clusters form in the naive population if we only use genes that are specific for the three germlayers. Again, we use PCA and tSNE to visualize potential clustering.

We can further colour the plots for specific markers of mesoderm, endoderm and ectoderm to see whether the clustering is in fact independent of the lineage.

```{r pca.naive}
lin.sce_naive <- sce_naive[lin.markers,]
lin.sce_naive$CDK1 <- norm_exprs(sce_naive['CDK1',])

#mesoderm
pca_naive1 <- plotPCA(lin.sce_naive, colour_by = 'SNAI1') + fontsize
#ectoderm
pca_naive2 <- plotPCA(lin.sce_naive, colour_by = 'ITGA6') + fontsize
#endoderm
pca_naive3 <- plotPCA(lin.sce_naive, colour_by = 'PAF1') + fontsize
#cell cycle
pca_naive4 <- plotPCA(lin.sce_naive, colour_by = 'CDK1') + fontsize

multiplot(pca_naive1, pca_naive2, pca_naive3, pca_naive4, cols = 2)
```

There are no distinct clusters visible and the first principal component is separating the cells with <5% variance, thus we assume that cells are still in a uncommited stage. We want to see whether the same results can be obtained via  tSNE.

```{r tsne.naive}
lin.sce_naive <- runTSNE(lin.sce_naive, perplexity=30, exprs_values="norm_exprs")

#mesoderm
tsne_naive1 <- plotTSNE(lin.sce_naive, colour_by= "SNAI1") + fontsize
saveRDS(tsne_naive1, file = file.path(resdir, 'naive_tsne1.Rds'))

#ectoderm
tsne_naive2 <- plotTSNE(lin.sce_naive, colour_by= "ITGA6") + fontsize
saveRDS(tsne_naive2, file = file.path(resdir, 'naive_tsne2.Rds'))

#endoderm
tsne_naive3 <- plotTSNE(lin.sce_naive, colour_by= "PAF1") + fontsize
saveRDS(tsne_naive3, file = file.path(resdir, 'naive_tsne3.Rds'))

#cell cycle
tsne_naive4 <- plotTSNE(lin.sce_naive, colour_by= 'CDK1') + fontsize
saveRDS(tsne_naive4, file = file.path(resdir, 'naive_tsne4.Rds'))

multiplot(tsne_naive1, tsne_naive2, tsne_naive3, tsne_naive4, cols = 2)
```

# Primed subpopulation

We now repeat the same analysis for the primed population. Again, it is necessary to remove the batch effects, which becomes obvious in the direct comparison to before removal. We perform Dim-reduction only on lineage markers and colours for cell-cycle expression for key lineage markers. First, PCA.

```{r pca.primed}
lin.sce_primed <- sce_primed[lin.markers,]
lin.sce_primed$CDK1 <- norm_exprs(sce_primed['CDK1',])

#mesoderm
pca_primed1 <- plotPCA(lin.sce_primed, colour_by = 'SNAI1') + fontsize
#ectoderm
pca_primed2 <- plotPCA(lin.sce_primed, colour_by = 'ITGA6') + fontsize
#endoderm
pca_primed3 <- plotPCA(lin.sce_primed, colour_by = 'PAF1') + fontsize
#cell cycle
pca_primed4 <- plotPCA(lin.sce_primed, colour_by = 'CDK1') + fontsize

multiplot(pca_primed1, pca_primed2, pca_primed3, pca_primed4, cols = 2)
```

Then, se do the same with tSNE.

```{r tsne.primed}
lin.sce_primed <- runTSNE(lin.sce_primed, perplexity=30, exprs_values="norm_exprs")

#mesoderm
tsne_primed1 <- plotTSNE(lin.sce_primed, colour_by= "SNAI1") + fontsize
saveRDS(tsne_primed1, file = file.path(resdir, 'primed_tsne1.Rds'))

#ectoderm
tsne_primed2 <- plotTSNE(lin.sce_primed, colour_by= "ITGA6") + fontsize
saveRDS(tsne_primed2, file = file.path(resdir, 'primed_tsne2.Rds'))

#endoderm
tsne_primed3 <- plotTSNE(lin.sce_primed, colour_by= "PAF1") + fontsize
saveRDS(tsne_primed3, file = file.path(resdir, 'primed_tsne3.Rds'))

#cell cycle
tsne_primed4 <- plotTSNE(lin.sce_primed, colour_by= 'CDK1') + fontsize
saveRDS(tsne_primed4, file = file.path(resdir, 'primed_tsne4.Rds'))

multiplot(tsne_primed1, tsne_primed2, tsne_primed3, tsne_primed4, cols = 2)
```

# Wrapping up

We save relevant objects for subsequent analysis and print the sessionInfo.

```{r end}
saveRDS(lin.markers, file = file.path(resdir, 'lin.markers.rds'))
saveRDS(sce_naive, file = file.path(resdir, "sce_naive_diff.rds"))
saveRDS(sce, file = file.path(resdir, "sce_all_diff.rds"))
saveRDS(sce_primed, file = file.path(resdir, "sce_primed_diff.rds"))
gc()
sessionInfo()
```
